<!DOCTYPE HTML>
<html>
	<head>
		<title>WebSockets on Azure</title>
		<link rel="stylesheet" type="text/css" media="screen" href="/client/styles.css">
		<script src="//ajax.googleapis.com/ajax/libs/jquery/2.1.0/jquery.min.js"></script>
		<script type="text/javascript" src="/client/melonjs-0.9.11.js"></script>
		<script type="text/javascript" src="/client/game.js"></script>
		<script type="text/javascript" src="/client/resources.js"></script>
		<script type="text/javascript" src="/client/screens/title.js"></script>
		<script type="text/javascript" src="/client/screens/play.js"></script>
		<script type="text/javascript" src="/client/entities/entities.js"></script>
		<script type="text/javascript" src="/client/entities/HUD.js"></script>
	</head>	
	<body>
		<div id="join">
			<label for="nickname">nick:</label><br/>
			<input type="text" id="nickname"/>
			<input type="button" id="btnjoin" value="Join"/>
		</div>
		<div id="chat" style="display:none;">
			<span id="username"></span><br/>
			<label for="message">message:</label><br/>
			<input type="text" id="message"/><br/>
			<input type="button" id="btnsend" value="Send"/>
		</div>
		<div id="screen" style="float:left;height:640px;"></div>
		<ul id="chatlog"></ul>
		<script type="text/javascript">
			$(function() {

				// Setup the Web Socket Connection
				var host = location.origin.replace(/^http/, "ws");
				var ws = new WebSocket(host);
				var user = {
					id: "123121",
					name: "Matt"
				};
				
				ws.onmessage = function(e) {
					var msg = JSON.parse(e.data);
					switch(msg.type) {
						case "joinResponse":
							user = msg.data;
							$("#join").hide();
							$("#chat").show();
							$("#username").append(user.name);
							game.onload();
							break;
						case "chat":
							var entry = "<li><strong>" + msg.data.name + ":</strong> " + msg.data.text + "</li>";
							$("#chatlog").append(entry);
							break;
					}
				};

				var sendMessage = function(text) {
					ws.send(JSON.stringify({
						type: "chat",
						user: user,
						data: text
					}));
					$("#message").val("");
				};

				var join = function(name) {
					ws.send(JSON.stringify({
						type: "join",
						user: {
							id: "",
							name: name 
						}
					}));
				};

				$("#btnjoin").click(function() {
					var name = $("#nickname").val();
					join(name);
				});

				$("#nickname").keyup(function(e) {
					var key = e.which;
					if(key == 13) {
						e.preventDefault();
						var name = $("#nickname").val();
						join(name);
					}
				});

				$("#btnsend").click(function() {
					var text = $("#message").val();
					sendMessage(text);
				});

				$("#message").keyup(function(e) {
					var key = e.which;
					if(key == 13) {
						e.preventDefault();
						var text = $("#message").val();
						sendMessage(text);
					}
				});
			});
		</script>
	</body>
</html>